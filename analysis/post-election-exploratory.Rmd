---
title: "Pre- and post-election EDA"
output:
  pdf_document:
    toc: true
  html_document:
    toc: true
    df_print: paged
---

# Setup and read in data

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
knitr::opts_chunk$set(dev = "png", dev.args = list(type = "cairo-png"))
knitr::opts_chunk$set(fig.width = 12, fig.height = 8)
options(knitr.table.format = "html")
library(tidyverse)
library(viridis)
library(here)
library(ggthemes)
library(knitr)
library(jsonlite)
library(patchwork)

theme_set(theme_bw())

response_type_colors <- c(
  "Harris" = "darkblue", "she" = "blue",
  "Trump" = "darkred", "he" = "red",
  "NP" = "darkgreen", "they" = "#15bb36",
  "hedged" = "#293629"
)
response_type_colors_all <- c(response_type_colors, "OTHER" = "gray")

scale_fill_response_types_all <- scale_fill_manual(
  values = response_type_colors_all,
  breaks = names(response_type_colors_all)
)
scale_fill_response_types <- scale_fill_manual(
  values = response_type_colors,
  breaks = names(response_type_colors),
  drop = FALSE
)
candidate_colors <- c(
  "Harris" = "darkblue", "Trump" = "darkred",
  "other" = "gray"
)
pronoun_colors <- c(
  "she" = "blue", "he" = "red",
  "they" = "#15bb36"
)
scale_color_pronouns <- scale_color_manual(
  values = pronoun_colors,
  breaks = names(pronoun_colors)
)
scale_fill_pronouns <- scale_fill_manual(
  values = pronoun_colors,
  breaks = names(pronoun_colors)
)

read_processed <- function(csv, show_col_types = FALSE, ...) {
  readr::read_csv(
    here(file.path("data", "processed", csv)),
    show_col_types = show_col_types, ...
  ) |> dplyr::mutate(batch = factor(batch, levels = c("pre", "post")))
}
```

```{r read}
recall_question <- read_processed("pre_recall_question.csv") |>
  bind_rows(read_processed("post_recall_question.csv"))

expectations <- read_processed("pre_expectations.csv") |>
  bind_rows(read_processed("post_expectations.csv")) |>
  mutate(
    candidate = recode(candidate, harris = "Harris", trump = "Trump"),
    candidate = factor(candidate, levels = c("Harris", "Trump", "other"))
  )

cloze <- read_processed("pre_cloze.csv") |>
  bind_rows(read_processed("post_cloze.csv")) |>
  mutate(
    response_type = factor(response_type,
      levels = c(
        "Harris", "pronoun female", "Trump", "pronoun male",
        "hedged", "ambiguous NP", "pronoun neutral", "OTHER"
      ),
      labels = c(
        "Harris", "she", "Trump", "he",
        "hedged", "NP", "they", "OTHER"
      )
    )
  )

spr <- read_processed("pre_spr.csv") |>
  bind_rows(read_processed("post_spr.csv")) |>
  mutate(
    nth_pronoun = factor(case_when(is_pron1 ~ 1, is_pron2 ~ 2, .default = NA)),
    pronoun_gender = factor(case_when(is_pron1 ~ type1, is_pron2 ~ type2, .default = NA)),
    match = type1 == type2 # whether the pronouns in the two sentences matched
  )

# spr_all <- read_processed("pre_spr_all.csv") |>
#   bind_rows(read_processed("post_spr_all.csv"))

maze <- read_processed("pre_maze.csv") |>
  bind_rows(read_processed("post_maze.csv")) |>
  mutate(
    nth_pronoun = factor(case_when(is_pron1 ~ 1, is_pron2 ~ 2, .default = NA)),
    pronoun_gender = factor(case_when(is_pron1 ~ type1, is_pron2 ~ type2, .default = NA)),
    match = type1 == type2 # whether the pronouns in the two sentences matched
  )

participants <- read_processed("pre_participants.csv") |>
  bind_rows(read_processed("post_participants.csv"))

# Check for participant ids present in both batches (shouldn't exist)
participants_both <- participants |>
  group_by(workerid) |>
  filter(n_distinct(batch) > 1) |>
  pull(workerid)

if (length(participants_both) > 0) {
  warning("Participants who completed both surveys: ", participants_both)
}
```

# Exploratory Data analysis

## Event expectation

```{r fig.height=4}
# Test whether expectations differ from 50-50 in each batch
expectations_test <- drop_na(expectations, probability) |>
  summarize(.by = c(batch, workerid), p = probability[candidate == "Trump"]) |>
  summarize(.by = batch,
    n = n(),
    mean_prob = mean(p),
    t_stat = t.test(p, mu = 0.5)$statistic,
    p_value = t.test(p, mu = 0.5)$p.value,
    ci_lower = t.test(p, mu = 0.5)$conf.int[1],
    ci_upper = t.test(p, mu = 0.5)$conf.int[2]
  ) 
expectations_test |> 
  ggplot(aes(x = mean_prob, y = batch)) +
  geom_vline(xintercept = 0.5, linetype = "dashed", color = "gray50") +
  geom_pointrange(aes(xmin = ci_lower, xmax = ci_upper)) +
  labs(
    x = "Mean expectation [Pr(Trump)]",
    title = "Probability Trump president in Feb 2025",
    subtitle = "For pre- and post-election batches of responses."
  ) +
  scale_x_continuous(labels = scales::percent) +
  facet_grid(batch~., scales="free")
expectations_test |>
  knitr::kable(
    digits = 3,
    caption = "One-sample t-tests comparing Trump probability to 50%"
  )

```


^ In the pre-election batch, mean expectations were 
`r paste0(round(100 * expectations_test$mean_prob[expectations_test$batch=="pre"], 3), "%")`, and this was not significantly different from 50%. 
In the post-election batch, mean expectations were 
`r paste0(round(100 * expectations_test$mean_prob[expectations_test$batch=="post"], 3), "%")`, and this was significantly different from 50%.

## Maze

Pairwise comparisons between genders (first pronoun only): 
Within each batch {pre-election, post-election}, is there a significant difference in reading times for each pairwise comparison among {male,female,neutral} pronouns?

```{r fig.height=4}
# Fit model with interaction
lm_maze <- lm(
  log(rt) ~ pronoun_gender * batch,
  data = maze |> filter(is_target, is_pron1) |> 
    mutate(batch = fct_rev(batch))
)

print_plot <- \(x, message=NULL) {
  if (!is.null(message)) message(message); print(x); plot(x)
}
emmeans::emm_options(sep = " ; ") # To use as a separator in labeling factor combinations
maze_emm <- emmeans::emmeans(lm_maze, ~ pronoun_gender : batch)

# maze_emm |> plot(by = "batch", comparisons = TRUE) + labs(
#   title = "Maze RT for each pronoun gender",
#   subtitle = "overlapping arrows mean difference in means not significant at 0.05 level",
#   y = "Pronoun gender", x = "residualized log RT"
# )
pairs(maze_emm, by = "batch", interaction = TRUE) |>
  print_plot("Pairwise differences between genders, for each batch") +
  geom_vline(xintercept = 0, lty = "dashed", color="gray") + 
  labs(
    title = "Pairwise difference in maze RT",
    y = "Pairwise comparison between genders", x = "Difference in log RT"
  )

# This should be equivalent to doing post-hoc comparisons like this:
# maze_models_resid <- maze |>
#   filter(is_target) |>
#   group_by(batch) |>
#   group_map(~lm(log(rt) ~ pronoun_gender, .x)) |>
#   setNames(c("pre", "post"))
# maze_models_resid |> lapply(\(x) TukeyHSD(aov(x)))
```
^ Pairwise comparisons between genders show, for Maze RTs: 

- in pre-election data, RT of female pronouns is larger than that of male pronouns, which in turn are slower than gender-neutral pronouns. All differences are significant at 0.05 level.
- in post-election data, RT of female pronouns is significantly larger than that of either male or neutral pronouns respectively, and difference between male and neutral pronouns is not significant.

Now, looking at interaction between each pairwise contrast, pre-vs-post election:
```{r fig.height=4}
# This will show if the contrasts significantly differ between pre and post
pairs(
  maze_emm, interaction = TRUE, 
) |>
  print_plot("Interaction of pairwise differences and batches") +
  geom_vline(xintercept = 0, lty = "dashed", color="gray") + 
  labs(
    title = "Interaction between batch and pairwise difference in maze RT",
    y = "Interaction", x = "Change in effect on log RT"
  )
```
^  interaction between each pairwise contrast among pronouns and experiment batch (pre- vs post-election).

- Comparing post-election minus pre-election

  - log RT difference he-she is negative --- that is, the bias for reading male faster than female pronouns increased.
  - log RT difference he-they is negative but smaller, and 
  - log RT difference she-they is positive but not significant.

And looking at the second pronoun:
```{r fig.height=4}
# Fit model with interaction
lm_maze2 <- lm(
  log(rt) ~ pronoun_gender * batch * match,
  data = maze |> filter(is_target, is_pron2) |> 
    mutate(batch = fct_rev(batch))
)

maze_emm2 <- emmeans::emmeans(lm_maze2, ~ pronoun_gender : match : batch)

# maze_emm2 |> plot(by = "batch", comparisons = TRUE) + labs(
#   title = "Maze RT for each pronoun gender",
#   subtitle = "overlapping arrows mean difference in means not significant at 0.05 level",
#   y = "Pronoun gender", x = "residualized log RT"
# )
pairs(maze_emm2, by = c("match", "batch"), interaction = TRUE) |>
  print_plot("Pairwise differences between genders, for each batch") +
  geom_vline(xintercept = 0, lty = "dashed", color="gray") + 
  labs(
    title = "Pairwise difference in maze RT",
    y = "Pairwise comparison between genders", x = "Difference in log RT"
  )

message("interaction with whether second pronoun matched first pronoun")
pairs(maze_emm2, by = c("batch"), interaction = TRUE) |>
  print()
```
 
## SPR

Pairwise comparisons between genders (first pronoun only): 
Within each batch {pre-election, post-election}, is there a significant difference in reading times for each pairwise comparison among {male,female,neutral} pronouns?

```{r fig.height=4}
# Fit model with interaction
lm_spr <- lm(
  log(rt_gmean) ~ pronoun_gender * batch,
  data = spr |> filter(is_target, is_pron1) |> 
    mutate(batch = fct_rev(batch))
)

print_plot <- \(x, message=NULL) {
  if (!is.null(message)) message(message); print(x); plot(x)
}
emmeans::emm_options(sep = " ; ") # To use as a separator in labeling factor combinations
spr_emm <- emmeans::emmeans(lm_spr, ~ pronoun_gender : batch)

# spr_emm |> plot(by = "batch", comparisons = TRUE) + labs(
#   title = "spr RT for each pronoun gender", 
#   subtitle = "overlapping arrows mean difference in means not significant at 0.05 level",
#   y = "Pronoun gender", x = "residualized log RT"
# )
pairs(spr_emm, by = "batch", interaction = TRUE) |>
  print_plot("Pairwise differences between genders, for each batch") +
  geom_vline(xintercept = 0, lty = "dashed", color="gray") + 
  labs(
    title = "Pairwise difference in SPR RT",
    y = "Pairwise comparison between genders", x = "Difference in log RT"
  )
```

^ Pairwise comparisons between genders show, for SPR RTs: 

- in pre-election data, 
  - RT of female pronouns is slower than that of neutral pronouns (p=0.0233) and 
  - RT of female pronouns is slower than that of male pronouns (p=0.0420). 
  - Male-neutral comparison is not significant (p=0.5474).
- in post-election data, 
  - RT of female pronouns is slower than that of neutral pronouns (p=0.0180) and 
  - RT of female pronouns is slower than that of male pronouns (p=0.0020). 
  - Male-neutral comparison is not significant (p=0.5474).

Next, looking at interaction between each pairwise contrast, pre-vs-post election:
```{r fig.height=4}
# This will show if the contrasts significantly differ between pre and post
pairs(
  spr_emm, interaction = TRUE, 
) |>
  print_plot("Interaction of pairwise differences and batches") +
  geom_vline(xintercept = 0, lty = "dashed", color="gray") + 
  labs(
    title = "Interaction between batch and pairwise difference in SPR RT",
    y = "Interaction", x = "Change in effect on log RT"
  )
```
^  interaction between each pairwise contrast among pronouns and experiment batch (pre- vs post-election).

- Comparing post-election minus pre-election

  - numerical speedup for he versus they and he versus she, and slowdown for she versus they, but no contrasts are significant.


And looking at the second pronoun:
```{r fig.height=4}
# Fit model with interaction
lm_spr2 <- lm(
  log(rt_gmean) ~ pronoun_gender * batch * match,
  data = spr |> filter(is_target, is_pron2) |> 
    mutate(batch = fct_rev(batch))
)

spr_emm2 <- emmeans::emmeans(lm_spr2, ~ pronoun_gender : match : batch)

# spr_emm2 |> plot(by = "batch", comparisons = TRUE) + labs(
#   title = "Maze RT for each pronoun gender",
#   subtitle = "overlapping arrows mean difference in means not significant at 0.05 level",
#   y = "Pronoun gender", x = "residualized log RT"
# )
pairs(spr_emm2, by = c("match", "batch"), interaction = TRUE) |>
  print_plot("Pairwise differences between genders, for each batch") +
  geom_vline(xintercept = 0, lty = "dashed", color="gray") + 
  labs(
    title = "Pairwise difference in maze RT",
    y = "Pairwise comparison between genders", x = "Difference in log RT"
  )

message("interaction with whether second pronoun matched first pronoun")
pairs(spr_emm2, by = c("batch"), interaction = TRUE) |>
  print()
```
 

------------------------------------------

## Other exploratory plotting



Number of participants per task pre- and post- election.
```{r}
participants |>
  group_by(batch) |>
  summarize(
    cloze = n_distinct(workerid[workerid %in% cloze$workerid]),
    maze = n_distinct(workerid[workerid %in% maze$workerid]), 
    spr = n_distinct(workerid[workerid %in% spr$workerid])
  ) |>
  mutate(total = cloze + maze + spr) |> knitr::kable()
```

### Expectations

Check for order effect on belief estimation results, in pre- and post- election data.
```{r fig.height=6}
expectations |>
  mutate(order = if_else(
    str_starts(condition, "event"), "event-trial", "trial-event"
  )) |>
  ggplot(aes(probability, candidate, color = candidate)) +
  labs(
    y = NULL,
    title = "\"Who do you think will be the US president in February 2025?\"",
    subtitle = "responses normalized per participant"
  ) +
  scale_color_manual(values = candidate_colors) +
  geom_violin(draw_quantiles = .5, alpha = 0.5) +
  facet_grid(order ~ batch) +
  geom_jitter(size = 0.5, alpha = 0.5, color = "gray") +
  stat_summary(fun.data = "mean_se", geom = "pointrange")
```

Looking for order effects, (combining all orders that start with "event" to one, for this plot, since all are identical wrt this data)
```{r fig.height=6}
expectations |>
  mutate(condition = factor(case_when(
    condition |> str_starts("event-") ~ "first",
    .default = paste("after", str_replace(condition, "-event", ""))
  ))|> fct_relevel("first")) |>
  ggplot(aes(probability, candidate, color = candidate)) +
  labs(
    y = NULL,
    title = "\"Who do you think will be the US president in February 2025?\"",
    subtitle = "responses normalized per participant, faceted by order"
  ) +
  scale_color_manual(values = candidate_colors) +
  facet_grid(condition ~ batch) +
  # geom_jitter(size = 0.5, alpha = 0.5, color = "gray") +
  stat_summary(fun.data = "mean_se", geom = "pointrange")
```

### Cloze

```{r fig.height=5}
cloze_categorized <- cloze |> # filter(response_type!="OTHER") |>
  mutate(category = case_when(
    response_type %in% c("Harris", "she") ~ "female",
    response_type %in% c("Trump", "he") ~ "male",
    response_type %in% c("hedged", "they", "NP") ~ "neutral",
    .default = "OTHER"
  ))
cloze_categorized |>
  ggplot(aes(category, fill = response_type)) +
  geom_bar() + facet_wrap(~batch) +
  geom_text(stat = "count", aes(label = ..count..), color = "white", position = position_stack(vjust = 0.5)) +
  scale_fill_response_types +
  labs(title = "Type of cloze responses") 
```

```{r}
F_count <- nrow(filter(cloze, batch=="pre", response_type=="she"))
M_count <- nrow(filter(cloze, batch=="pre", response_type=="he"))
# N_count <- nrow(filter(cloze, batch=="pre", response_type=="pronoun neutral"))

# Test whether proportion F is significantly different from 50%
c(`prop.test(F, M+F) p-value`=prop.test(F_count, M_count+F_count)$p.value)
```

Faceting by order:
```{r fig.height=5}
cloze_categorized |>
  ggplot(aes(category, fill = response_type)) +
  geom_bar() +
  geom_text(stat = "count", aes(label = ..count..), color = "white", position = position_stack(vjust = 0.5)) +
  facet_wrap(condition~batch, scales = "free_y") +
  scale_fill_response_types +
  labs(title = "Type of cloze responses, faceted by order") 
```
In the event-cloze order there seems to be a somewhat larger bias toward producing male pronouns or male referents/Trump.

_But it seems the difference between orders here is actually not significant, per Titus' binomial 95%-HPDI test:_
```{r fig.width = 6, fig.height = 3, out.width="60%"}
# remotes::install_github("tmalsburg/binomialCRIs")
if (require("binomialCRIs")) {
  F_before <- nrow(filter(cloze,batch=="pre", condition=="cloze-event", response_type=="she"))
  M_before <- nrow(filter(cloze,batch=="pre", condition=="cloze-event", response_type=="he"))
  F_after <- nrow(filter(cloze, batch=="pre", condition=="event-cloze", response_type=="she"))
  M_after <- nrow(filter(cloze, batch=="pre", condition=="event-cloze", response_type=="he"))
  plot_binomial_hpdi(
    n_successes = F_before, n_trials = F_before + M_before,
    prob = 0.95
  ) +
    geom_vline(xintercept = F_after / (F_after + M_after)) +
    labs(
      title = "Binomial HPDI check for order effect (in pre-election data)",
      subtitle = paste(
        "posterior for proportion fem. in cloze-event\n",
        "vertical line at proportion fem. in event-cloze"
      )
    )
}

```

#### By item cloze breakdown
```{r fig.height=14}
plot_cloze_facet_items <- function(data, title) {
  data |>
    ggplot(aes(category, fill = response_type)) +
    geom_bar() +
    facet_wrap(~ paste0(
      sprintf("%02d", item), ":\n",
      gsub("(.{40})", "\\1\n", partial)
    )) +
    geom_text(stat = "count", aes(label = ..count..), color="white", size=2, position = position_stack(vjust = .5)) +
    scale_fill_response_types +
    labs(title = title)
}

p_ci1 <- plot_cloze_facet_items(cloze_categorized |>
    filter(batch == "pre", category != "OTHER"), "pre-election")
p_ci2 <- plot_cloze_facet_items(cloze_categorized |>
    filter(batch == "post", category != "OTHER"), "post-election")

p_ci1 / p_ci2 +
  plot_annotation(title="Type of cloze responses, by item",subtitle = "(OTHER responses not shown)")
```

### Maze
Look at average Maze RT by gender of pronoun, and for each condition of two sentences presented.
Shows an effect of gender (male pronoun is read faster than female, neutral is perhaps even faster than male).
These Maze RTs are residualized as with the SPR (control for participant mean reading speed and eg word length, punctuation, and by item effects).
```{r}
# maze |>
#   count(item1, item2, type, type1, type2) |>
#   ggplot(aes(factor(item1), factor(item2), size = n, color = type)) +
#   geom_point() +
#   facet_grid(type1 ~ type2)
```

```{r}
p_maze1 <- maze |>
  filter(is_target, is_pron1) |>
  ggplot(aes(batch, log(rt), color = factor(pronoun_gender))) +
  stat_summary(position=position_dodge2(width=.5)) +
  scale_color_pronouns +
  labs(
     y= "log residualized RT",
    title = "Maze RT on pronouns by gender, first pronoun", 
    color = "pronoun gender", subtitle = "overall"
    )

p_maze2 <- maze |>
  filter(is_target, is_pron1) |>
  summarise(
    .by = c(batch, nth_pronoun, pronoun_gender, type),
    m = mean(log(rt)),
    se = sd(log(rt)) / sqrt(n()),
  ) |>
  ggplot(aes(interaction(nth_pronoun,batch), m, group = batch, color = factor(pronoun_gender))) +
  geom_pointrange(
    aes(ymin = m - se, ymax = m + se),
    position = position_dodge(width = .5)
  ) +
  geom_line(aes(lty=batch),color="darkgray", position = position_dodge(width = .5)) +
  facet_grid(~type, scales = "free") +
  scale_color_pronouns +
  labs(
    x = "nth_pronoun . batch", y= "log residualized RT",
    title = "Maze RT on pronouns by stimulus type", color = "pronoun gender",
    subtitle = "(gender of pronoun in each of two sentences read back to back)"
  )

p_maze <- (p_maze1 / p_maze2) + plot_layout(guides = "collect")
p_maze
```

Faceting by order
```{r fig.height=4}
maze |>
  filter(is_target, is_pron1) |>
  ggplot(aes(pronoun_gender, shape=condition, log(rt), color = factor(pronoun_gender))) +
  stat_summary() +
  scale_color_pronouns +
  facet_grid(batch~condition, scales = "free") +
  labs(title = "Maze RT on pronouns by gender",  y= "log residualized RT", subtitle = "facet by order", color = "pronoun gender")
```

^ In the pre-election data (top facets above), there may be a slightly less clear male pronoun bias for participants who 
did the maze task following the event estimation (event-maze) versus before (maze-event).  In the post-election data, the bias was strong in either order.

And broken down by participant reported preference
```{r fig.height=6}
participants |>
  select(workerid, prefer) |>
  inner_join(maze, join_by(workerid)) |>
  filter(is_target, is_pron1) |>
  mutate(prefer = if_else(!(prefer %in% c("Donald Trump", "Kamala Harris")), "Refuse/No pref./NA", prefer)) |>
  ggplot(aes(pronoun_gender, log(rt), color = factor(pronoun_gender))) +
  stat_summary() +
  facet_grid(batch ~ interaction( prefer)) +
  scale_color_pronouns +
  labs(
    title = "SPR RT on pronouns by participant's reported candidate preference",
    color = "pronoun gender", subtitle = "overall",  y= "log residualized RT"
  )
```
^ The pre-election bias is least strong among participants whose preferred candidate was Harris.


We could look at a related effect as a continuous interaction plotting event-probability (who the participant thinks will be president) on the x-axis versus RT on the y-axis:
```{r}
maze_expectations <- expectations |>
  pivot_wider(names_from = candidate, values_from = c(probability, response)) |>
  select(workerid, starts_with("probability")) |>
  left_join(maze)
p_maze_ex <- maze_expectations |>
  filter(correct, is_target, is_pron1, batch == "pre") %>%
  ggplot(aes(probability_Harris, log(rt), color = pronoun_gender)) +
  geom_rug(sides="b") +
  geom_smooth(data = . %>% 
    filter(probability_Harris >= quantile(probability_Harris, 0.15),
           probability_Harris <= quantile(probability_Harris, 0.85)),
    # method = "lm"
  ) +
  xlim(0,1) +
  scale_color_pronouns +
  labs(
    title = "Maze RT on pronouns, plotted against probability of female president",
    # subtitle = "only pre-election data, middle 90%",
    x = "belief that president will be Harris", y = "Maze RT (log scale)"
  )
p_ex_hist <- maze_expectations |>
  filter(correct, is_target, is_pron1, batch == "pre") |>
  select(probability_Harris, pronoun_gender) |>
  distinct() %>%
  {
    quants <- quantile(.$probability_Harris, c(0.05, 0.25, 0.5, 0.75, 0.95))
    ggplot(., aes(probability_Harris, fill=pronoun_gender)) +
      geom_histogram(bins=25, center=0.5) +
      scale_fill_pronouns +
      geom_vline(xintercept = quants) +
      scale_y_reverse() +
      xlim(0,1) +
      theme_minimal()
  }

p_maze_ex / p_ex_hist + plot_layout(heights = c(4, 1))
```
^ It looks like the male-pronoun processing bias (/ female-pronoun processing penalty) gets smaller as belief that the president would be female is higher.  But note the majority of participants are in the middle of the distribution.

```{r}
participants |>
  select(workerid, gender, age) |>
  inner_join(maze, join_by(workerid)) |>
  filter(is_target, is_pron1, age < 100) |>
  ggplot(aes(age, log(rt), color = pronoun_gender)) +
  geom_smooth(method = "lm") +
  # geom_point(alpha=0.25) +
  scale_color_pronouns +
  facet_grid(~ batch) +
  labs(
    title = "Maze RT on pronouns, plotted against participant age",
    x = "age", y = "Maze RT (log scale)"
  )
```
^Looking at participant age, there also could be something interesting going on, at least with the decreasing processing cost of the neutral pronoun for younger readers.


#### Maze reading time tracks on each of the target sentences:


```{r fig.height=12}
maze |>
  mutate(
    full_type = type, full_item = item,
    s = case_when(in_s == 0 ~ s0, in_s == 1 ~ s1, in_s == 2 ~ s2),
    type = case_when(in_s == 0 ~ NA, in_s == 1 ~ type1, in_s == 2 ~ type2),
    item = case_when(in_s == 0 ~ 0, in_s == 1 ~ item1, in_s == 2 ~ item2),
  ) |>
  filter(
    # Filter to not get effects from switching pronouns midstream
    # (only use first sentence)
    in_s == 1
  ) |>
  select(-c(type1, type2, item1, item2)) |>
  summarize(
    # summarize by `in_s` or `full_type` to get sentence order effect
    .by = c(batch, item, type, word_number_in_s, is_target, word),
    n = n(),
    m = mean(log(rt)),
    se = sd(log(rt)) / sqrt(n)
  ) |>
  filter(item != 0) |>
  ggplot(aes(
    word_number_in_s,
    m, ymin = m - 1.96 * se, ymax = m + 1.96 * se,
    group = type, color = type
  )) +
  geom_line(alpha = 0.5) +
  scale_color_pronouns +
  geom_pointrange(aes(size = is_target, shape = is_target), alpha = 0.5) +
  scale_size_manual(values = c(0.5, 1)) +
  geom_text(aes(label=word,y=-Inf), alpha=0.33, angle = 15, vjust = -1, hjust = 0.5, size = 2) +
  facet_grid(item ~ batch, scales="free") +
  labs(title="Maze", y="log RT")
```

### SPR

Likewise look at average SPR RT by gender of pronoun, and for each condition of two sentences presented.
These RTs are residualized.
<!-- Results look similar to Maze RTs, but are less pronounced/lower power. -->


```{r}
# spr |>
#   count(item1, item2, type, type1, type2) |>
#   ggplot(aes(factor(item1), factor(item2), size = n, color = type)) +
#   geom_point() +
#   facet_grid(type1 ~ type2)

p_spr1 <- spr |>
  filter(is_target, is_pron1) |>
  ggplot(aes(batch, log(rt_gmean), color = factor(pronoun_gender))) +
  stat_summary(position=position_dodge2(width=.5)) +
  scale_color_pronouns +
  labs(
     y= "log residualized RT avg in 4-word window",
    title = "SPR RT on pronouns by gender", 
    color = "pronoun gender", subtitle = "overall"
    )

p_spr2 <- spr |>
  filter(is_target, is_pron1) |>
  summarise(
    .by = c(batch, nth_pronoun, pronoun_gender, type),
    m = mean(log(rt_gmean)),
    se = sd(log(rt_gmean)) / sqrt(n()),
  ) |>
  ggplot(aes(interaction(nth_pronoun,batch), m, group = batch, color = factor(pronoun_gender))) +
  geom_pointrange(
    aes(ymin = m - se, ymax = m + se),
    position = position_dodge(width = .5)
  ) +
  geom_line(aes(lty=batch),color="darkgray", position = position_dodge(width = .5)) +
  facet_grid(~type, scales = "free") +
  scale_color_pronouns +
  labs(
    x = "nth_pronoun . batch", y= "log residualized RT avg in 4-word window",
    title = "SPR RT on pronouns by stimulus type", color = "pronoun gender",
    subtitle = "(gender of pronoun in each of two sentences read back to back)"
  )

p_spr <- (p_spr1 / p_spr2) + plot_layout(guides = "collect")
p_spr
```
Faceting by order
```{r fig.height=4}
spr |>
  filter(is_target, is_pron1) |>
  ggplot(aes(pronoun_gender, shape=condition, log(rt_gmean), color = factor(pronoun_gender))) +
  stat_summary() +
  scale_color_pronouns +
  facet_grid(batch~condition, scales = "free") +
  labs(title = "Maze RT on pronouns by gender", subtitle = "facet by order", color = "pronoun gender")
```

^ Probably not enough power to detect, but it may be true that the bias is stronger in the spr-event order, as with Maze data.

```{r}
## Inspect:
## Comparing different lags,
## rather than just using the mean over the whole window
rt_lag_colors <- c(
  `w_{i}` = "black",
  `w_{i+1}` = "darkgray",
  `w_{i+2}` = "gray",
  `w_{i+3}` = "lightgray",
  avg = "purple"
)
scale_color_rt_lag <- scale_color_manual(
  values = rt_lag_colors,
  breaks = names(rt_lag_colors)
)
plot_spr_lags <- function(spr, linetype=1) {
  spr_longer <- spr |>
    select(-rt.raw) |>
    filter(is_target) |>
    pivot_longer(
      cols = starts_with("rt"), names_to = "RT lag", values_to = "reading_time"
    ) |>
    mutate(`RT lag` = case_when(
      `RT lag` == "rt_gmean" ~ "avg",
      str_starts(`RT lag`, "rt_") ~ paste(gsub("rt_(.)next", "w_{i+\\1}", `RT lag`)),
      `RT lag` == "rt" ~ "w_{i}",
    ))

  p_spr_lags1 <- spr_longer |>
    ggplot(aes(`RT lag`, log(reading_time), color = `RT lag`)) +
    stat_summary() +
    facet_grid(condition ~ pronoun_gender, scales = "free") +
    scale_color_rt_lag +
    labs(
      title = "SPR by gender",
      subtitle = "Looking at RT with different lags w_{i+n}, where w_i = target pronoun. \nAlso showing geometric_mean(w_{i+n}) for n = {0,...,3}",
      y = "residualized log RT"
    )

  p_spr_lags2 <- spr_longer |>
    summarize(
      .by = c(`RT lag`, nth_pronoun, type, condition),
      m = mean(log(reading_time)),
      se = sd(log(reading_time)) / sqrt(n())
    ) |>
    ggplot(aes(x = nth_pronoun, group = `RT lag`, y = m, ymin = m - se, ymax = m + se, color = `RT lag`)) +
    geom_pointrange(position = position_dodge(width = .4)) +
    facet_grid(condition ~ type, scales = "free") +
    geom_line(position = position_dodge(width = .4), linetype=linetype) +
    scale_color_rt_lag +
    labs(
      title = "Maze RT on pronouns by stimulus type",
      subtitle = "(gender of pronoun in each of two sentences read back to back)",
      y = "residualized log RT"
    )
  p_spr_lags <- (p_spr_lags1 / p_spr_lags2) + plot_layout(guides = "collect")
}

plot_spr_lags(spr |> filter(batch=="pre"), linetype=1) + plot_annotation(title="Pre-election data")

plot_spr_lags(spr |> filter(batch=="post"), linetype=2)+ plot_annotation(title="Post-election data")
```


```{r fig.height=4}
participants |>
  select(workerid, gender) |>
  inner_join(spr, join_by(workerid)) |>
  filter(is_target, gender %in% c("Female", "Male")) |>
  ggplot(aes(pronoun_gender, log(rt_gmean), color = factor(pronoun_gender))) +
  stat_summary() +
  facet_grid(batch~gender) +
  scale_color_pronouns +
  labs(
    title = "SPR RT on pronouns by participant's reported gender",
    color = "pronoun gender", subtitle = "overall"
  )
```

^ SPR averages broken down by participant gender may be useful if we're interesed in the difference that shows up in Maze as well: bias seems larger in males.

```{r fig.height=6}
participants |>
  select(workerid, political_aff) |>
  inner_join(spr, join_by(workerid)) |>
  filter(is_target, political_aff %in% c("Democrat", "Republican", "Independent")) |>
  ggplot(aes(pronoun_gender, log(rt_gmean), color = factor(pronoun_gender))) +
  stat_summary() +
  facet_grid(batch~political_aff) +
  scale_color_pronouns +
  labs(
    title = "SPR RT on pronouns by participant's reported political affil.",
    color = "pronoun gender", subtitle = "overall"
  )
```
^ SPR averages broken down by participant political affiliation, as with Maze above.


#### SPR tracks on each of the target sentences:

```{r fig.height=12}
spr |>
  mutate(
    full_type = type, full_item = item,
    s = case_when(in_s == 0 ~ s0, in_s == 1 ~ s1, in_s == 2 ~ s2),
    type = case_when(in_s == 0 ~ NA, in_s == 1 ~ type1, in_s == 2 ~ type2),
    item = case_when(in_s == 0 ~ 0, in_s == 1 ~ item1, in_s == 2 ~ item2),
  ) |>
  filter(
    # Filter to not get effects from switching pronouns midstream
    # (only use first sentence)
    in_s == 1
  ) |>
  select(-c(type1, type2, item1, item2)) |>
  mutate(rt_selected = rt) |>
  summarize(
    # summarize by `in_s` or `full_type` to get sentence order effect
    .by = c(batch, item, type, word_number_in_s, is_target, word),
    n = n(),
    m = mean(log(rt_selected)),
    se = sd(log(rt_selected)) / sqrt(n)
  ) |>
  filter(item != 0) |>
  ggplot(aes(
    word_number_in_s,
    m, ymin = m - 1.96 * se, ymax = m + 1.96 * se,
    group = type, color = type
  )) +
  geom_line(alpha = 0.5) +
  scale_color_pronouns +
  geom_pointrange(aes(size = is_target, shape = is_target), alpha = 0.5) +
  scale_size_manual(values = c(0.5, 1)) +
  geom_text(aes(label=word,y=-Inf), alpha=0.33, angle = 15, vjust = -1, hjust = 0.5, size = 2) +
  facet_grid(item ~ batch, scales="free") +
  labs(title="SPR", y="log residualized RT")
```



# HSP abstract

```{r}
# Where to save plots
outdir_abstract <- here(
  file.path("output", "HSP2025-abstract")
)

participants |> group_by(condition, batch) |> tally()

participants |> filter(str_detect(condition, "spr")) |> group_by(batch) |> tally()

response_type_colors_ABSTRACT <- c(
  "Harris" = "darkblue", "she" = "blue",
  "Trump" = "darkred", "he" = "red",
  "hedged" = "darkgreen", "they" = "#258d3a",
  "NP" = "lightgreen",
  "OTHER" = "gray"
)
scale_fill_response_types_ABSTRACT <- scale_fill_manual(
  values = response_type_colors_ABSTRACT,
  breaks = names(response_type_colors_ABSTRACT)
)
pronoun_colors_ABSTRACT <- c(
  "she" = "blue", "he" = "red",
  "they" = "#258d3a"
)
scale_color_pronouns_ABSTRACT <- scale_color_manual(
  values = pronoun_colors_ABSTRACT,
  breaks = names(pronoun_colors_ABSTRACT)
)

```

```{r}

expectations |> mutate(batch=factor(batch, levels=c("pre", "post"), labels=c("Pre", "Post"))) |> ggplot(aes(x=candidate, y=probability, fill=candidate))+
    stat_summary(fun.data="mean_cl_boot", geom="bar", width=.5)+
    stat_summary(fun.data="mean_cl_boot", color="black", geom="linerange", size=2)+
  facet_grid(~batch)+
  scale_fill_manual(values=candidate_colors)+
  scale_y_continuous(limits=c(0,1))+
  theme(legend.position = "none",
        axis.title=element_text(size="14"),
        axis.text=element_text(size="14"),
        strip.text = element_text(size="14"),
        axis.title.x=element_blank(),
        strip.background = element_blank())

ggsave(file.path(outdir_abstract, "expectation.pdf"), width = 5 , height = 2 )

```


```{r}
cloze_categorized_stats <- cloze |>
  mutate(category = case_when(
    response_type %in% c("Harris", "she") ~ "female",
    response_type %in% c("Trump", "he") ~ "male",
    response_type %in% c("hedged", "they", "NP") ~ "neutral",
    .default = "OTHER"
  )) |>
  group_by(batch, response_type, category) |>
  summarize(n = n()) |>
  group_by(batch) |>
  mutate(n = n / sum(n))

cloze_categorized_stats |> mutate(batch=factor(batch, levels=c("pre", "post"), labels=c("Pre", "Post"))) |> filter(response_type!="OTHER") |> ungroup() |> 
  ggplot(aes(category, n,fill = response_type)) +
          geom_col( color="black") + 
   facet_wrap(~batch) +
  scale_fill_response_types_ABSTRACT +
  guides(fill=guide_legend(nrow=2))+
  labs(y="Fraction")+
    theme(legend.position = "bottom",
          legend.title=element_blank(),
        axis.title=element_text(size="14"),
        axis.text=element_text(size="14"),
        strip.text = element_text(size="14"),
        axis.title.x=element_blank(),
                legend.text=element_text(size="14"),

        strip.background = element_blank())

ggsave(file.path(outdir_abstract, "cloze.pdf"), width = 5, height = 3)

```


```{r}
m1 <- maze |>mutate(batch=factor(batch, levels=c("pre", "post"), labels=c("Pre", "Post"))) |>
  mutate(pronoun_gender=factor(pronoun_gender, levels=c("she", "he", "they"))) |> 
  filter(is_target, is_pron1) |> 
  ggplot(aes(pronoun_gender, log(rt), color = factor(pronoun_gender))) +
  stat_summary(position=position_dodge2(width=.5)) +
  scale_color_pronouns_ABSTRACT +
  labs(
     y= "log residualized RT",
    color = "pronoun gender"
    )+
  facet_wrap(~batch)+
  theme(legend.position = "none",
          legend.title=element_blank(),
        axis.title=element_text(size="14"),
        axis.text=element_text(size="14"),
        strip.text = element_text(size="14"),
        axis.title.x=element_blank(),
                legend.text=element_text(size="14"),

        strip.background = element_blank())

ggsave(file.path(outdir_abstract, "maze.pdf"), width= 5, height =2.5)

m2 <- maze |>mutate(batch=factor(batch, levels=c("pre", "post"), labels=c("Pre", "Post"))) |>   mutate(pronoun_gender=factor(pronoun_gender, levels=c("she", "he", "they"))) |> 
  filter(is_target, is_pron2) |> 
  mutate(match=ifelse(type %in% c('she-she', 'he-he', 'they-they'), "match", "mismatch")) |> 
  ggplot(aes(pronoun_gender, log(rt), color = factor(pronoun_gender), shape=match, lty=match)) +
  stat_summary(position=position_dodge2(width=.5)) +
  scale_color_pronouns_ABSTRACT +
  guides(shape=guide_legend(), color="none")+
  labs(
     y= "log residualized RT",
    color = "pronoun gender"
    )+
  facet_wrap(~batch)+
  theme(legend.position = "bottom",
          legend.title=element_blank(),
        axis.title=element_text(size="14"),
        axis.text=element_text(size="14"),
        strip.text = element_text(size="14"),
        axis.title.x=element_blank(),
                legend.text=element_text(size="14"),

        strip.background = element_blank())

ggsave(file.path(outdir_abstract, "maze2.pdf"), width = 5, height =2.5)

```


```{r}
spr |>mutate(batch=factor(batch, levels=c("pre", "post"), labels=c("Pre", "Post"))) |> 
    mutate(pronoun_gender=factor(pronoun_gender, levels=c("she", "he", "they"))) |> 
  filter(is_target, is_pron1) |> 
  ggplot(aes(pronoun_gender, log(rt_gmean), color = factor(pronoun_gender))) +
  stat_summary(position=position_dodge2(width=.5)) +
  scale_color_pronouns_ABSTRACT +
  labs(
     y= "log residualized RT",
    color = "pronoun gender"
    )+
  facet_wrap(~batch)+
  theme(legend.position = "none",
          legend.title=element_blank(),
        axis.title=element_text(size="14"),
        axis.text=element_text(size="14"),
        strip.text = element_text(size="14"),
        axis.title.x=element_blank(),
                legend.text=element_text(size="14"),

        strip.background = element_blank())

ggsave(file.path(outdir_abstract, "spr.pdf"), width= 5, height =2.5)

spr |>mutate(batch=factor(batch, levels=c("pre", "post"), labels=c("Pre", "Post"))) |> 
    mutate(pronoun_gender=factor(pronoun_gender, levels=c("she", "he", "they"))) |> 
  filter(is_target, is_pron2) |> 
  mutate(match=ifelse(type %in% c('she-she', 'he-he', 'they-they'), "match", "mismatch")) |> 
  ggplot(aes(pronoun_gender, log(rt_gmean), color = factor(pronoun_gender), shape=match, lty=match)) +
  stat_summary(position=position_dodge2(width=.5)) +
  scale_color_pronouns_ABSTRACT +
  guides(shape=guide_legend(), color="none")+
  labs(
     y= "log residualized RT",
    color = "pronoun gender"
    )+
  facet_wrap(~batch)+
  theme(legend.position = "bottom",
          legend.title=element_blank(),
        axis.title=element_text(size="14"),
        axis.text=element_text(size="14"),
        strip.text = element_text(size="14"),
        axis.title.x=element_blank(),
                legend.text=element_text(size="14"),

        strip.background = element_blank())

ggsave(file.path(outdir_abstract, "spr2.pdf"), width = 5, height =2.5)
```


# HSP poster

Need only run the `setup` and `read` chunks before below.

```{r}
# Where to save plots
outdir_poster <- here(
  file.path("output", "HSP2025-poster")
)
THEME_POSTER <- theme(
  axis.title = element_text(size = "14"),
  axis.text = element_text(size = "14"),
  strip.text = element_text(size = "14"),
  legend.text = element_text(size = "10"),
  legend.title = element_blank(),
  axis.title.x = element_blank(),
  strip.background = element_blank()
)
# participants |> group_by(condition, batch) |> tally()
# participants |> filter(str_detect(condition, "spr")) |> group_by(batch) |> tally()

cloze_categorized <- cloze |>
  mutate(category = case_when(
    response_type %in% c("Harris", "she") ~ "female",
    response_type %in% c("Trump", "he") ~ "male",
    response_type %in% c("hedged", "they", "NP") ~ "neutral",
    .default = "OTHER"
  )) 
cloze_expectations <- expectations |>
  pivot_wider(names_from = candidate, values_from = c(probability, response)) |>
  select(workerid, starts_with("probability")) |>
  right_join(cloze_categorized)
maze_expectations <- expectations |>
  pivot_wider(names_from = candidate, values_from = c(probability, response)) |>
  select(workerid, starts_with("probability")) |>
  right_join(maze)
spr_expectations <- expectations |>
  pivot_wider(names_from = candidate, values_from = c(probability, response)) |>
  select(workerid, starts_with("probability")) |>
  right_join(spr)

BATCH <- "pre"
```

```{r}
expectations |>
  filter(batch == BATCH) |>
  ggplot(aes(x = candidate, y = probability, fill = candidate)) +
  stat_summary(fun.data = "mean_cl_boot", geom = "bar", width = .5) +
  stat_summary(fun.data = "mean_cl_boot", color = "black", geom = "linerange", size = 2) +
  scale_fill_manual(values = candidate_colors) +
  scale_y_continuous(limits = c(0, 1)) +
  THEME_POSTER +
  theme(legend.position = "none")

ggsave(file.path(outdir_poster, glue::glue("expectation_{BATCH}.pdf")), width = 3.25 , height = 2.5)


plot_task_expectations_hist <- function(task_expectations, chosen_batch) {
  task_expectations |> 
  filter(batch == BATCH) |>
  select(workerid, starts_with("probability")) |>
  mutate(expect = factor(case_when(
    probability_Trump < .49 ~ "Expect female",
    probability_Trump > .511 ~ "Expect male",
    .default = "Even"
  ))) |>
  ggplot(aes(probability_Trump, fill = expect)) +
  geom_histogram(bins = 50, center = 0.5) +
  scale_fill_manual(values = c(
    "Expect female" = "darkblue", 
    "Expect male" = "darkred", 
    "Even" = "gray")) +
  THEME_POSTER +
  theme(axis.title.x = NULL, legend.position = "none") +
  labs(x = "Probability Trump")
}

expectations |>
  pivot_wider(names_from = candidate, values_from = c(probability, response)) |>
  plot_task_expectations_hist(BATCH)

ggsave(file.path(outdir_poster, glue::glue("expectation_hist_{BATCH}.pdf")), width = 3.5 , height = 2)

expectations |>
  filter(batch == BATCH) |>
  left_join(participants) |>
  pivot_wider(names_from = candidate, values_from = c(probability, response)) |>
  mutate(
    task = factor(case_when(
      str_detect(condition, "cloze") ~ "Cloze",
      str_detect(condition, "spr") ~ "SPR",
      str_detect(condition, "maze") ~ "Maze",
      .default = "Other")),
    order = if_else(str_starts(condition, "event"), "event-trial", "trial-event"),
    expect = factor(case_when(
      probability_Trump < .49 ~ "Expect female",
      probability_Trump > .511 ~ "Expect male",
      .default = "Even"))
  ) |>
  ggplot(aes(probability_Trump, color = order)) +
  facet_grid(task~.) +
  geom_histogram(bins = 50, center = 0.5, position ="stack") +
  # scale_fill_manual(values = c(
  #   "Expect female" = "darkblue", 
  #   "Expect male" = "darkred", 
  #   "Even" = "gray")) +
  THEME_POSTER +
  theme(axis.title.x = NULL, legend.position = "bottom") +
  labs(x = "Probability Trump")

## CLOZE
cloze_categorized |>
  summarize(.by = c(batch, response_type, category), n = n()) |>
  mutate(.by = "batch", n = n / sum(n)) |>
  filter(batch == BATCH) |>
  filter(response_type != "OTHER") |>
  ggplot(aes(category, n, fill = response_type)) +
  geom_col() +
  scale_fill_response_types +
  guides(fill = guide_legend(nrow = 2)) +
  labs(y = "Fraction") +
  THEME_POSTER +
  theme(
    legend.position = c(-.2,-.275),
    legend.justification='left',
    plot.margin = unit(c(0.1,0.1,3,0.1), 'lines')
  )

ggsave(file.path(outdir_poster, glue::glue("cloze_{BATCH}.pdf")), width = 3.25, height = 3)

cloze_expectations |>
  filter(batch == BATCH) |>
  mutate(
    expect = factor(case_when(
      probability_Harris > .51 ~ "Expect female",
      probability_Harris < .49 ~ "Expect male",
      .default = "Even"
    ))
  ) |>
  filter(expect != "Even") |>
  drop_na(expect) |>
  summarize(.by = c(batch, response_type, category, expect), n = n()) |>
  mutate(.by = "batch", n = n / sum(n)) |>
  filter(response_type != "OTHER") |>
  ggplot(aes(category, n, fill = response_type)) +
  geom_col() +
  scale_fill_response_types +
  guides(fill = guide_legend(nrow = 2)) +
  facet_wrap(~expect, nrow = 1) +
  labs(y = "Fraction") +
  THEME_POSTER +
  theme(
    legend.position = "bottom"
  )
if (BATCH == "pre") ggsave(
  file.path(outdir_poster, glue::glue("cloze_expect_{BATCH}.pdf")), width = 4.5, height = 3.5
)

cloze_expectations |>
  plot_task_expectations_hist(BATCH)

ggsave(file.path(outdir_poster, glue::glue("cloze_expectation_hist_{BATCH}.pdf")), width = 3.5 , height = 2)


## MAZE
maze |>
  filter(batch == BATCH) |>
  mutate(
    pronoun_gender = factor(pronoun_gender, levels = c("she", "he", "they"))
  ) |>
  filter(is_target, is_pron1) |>
  ggplot(aes(pronoun_gender, log(rt), color = factor(pronoun_gender))) +
  stat_summary(position = position_dodge2(width = .5)) +
  scale_color_pronouns +
  labs(y = "log residualized RT", color = "pronoun gender") +
  THEME_POSTER +
  theme(legend.position = "none")

ggsave(file.path(outdir_poster, glue::glue("maze_{BATCH}.pdf")), width = 3.25, height = 2.5)

maze |>
  filter(batch == BATCH) |>
  mutate(
    pronoun_gender = factor(pronoun_gender, levels = c("she", "he", "they"))
  ) |>
  filter(is_target, is_pron2) |>
  mutate(match = ifelse(type %in% c("she-she", "he-he", "they-they"), "match", "mismatch")) |>
  ggplot(aes(pronoun_gender, log(rt), color = factor(pronoun_gender), shape = match, lty = match)) +
  stat_summary(position = position_dodge2(width = .5)) +
  scale_color_pronouns +
  guides(shape = guide_legend(), color = "none") +
  labs(y = "log residualized RT", color = "pronoun gender") +
  THEME_POSTER +
  theme(
    legend.position = "bottom",
    legend.margin = margin(0.1, 0.1, 0.1, 0.1, "lines")
  )

ggsave(file.path(outdir_poster, glue::glue("maze2_{BATCH}.pdf")), width = 3.25, height = 2.5)

maze_expectations |>
  filter(batch == BATCH) |>
  mutate(
    pronoun_gender = factor(pronoun_gender, levels = c("she", "he", "they")),
    expect = factor(case_when(
      probability_Harris > .51 ~ "Expect female",
      probability_Harris < .49 ~ "Expect male",
      .default = "Even"
    ))
  ) |>
  filter(expect != "Even") |>
  filter(is_target, is_pron1) |>
  drop_na(expect) |>
  ggplot(aes(pronoun_gender, log(rt), color = factor(pronoun_gender))) +
  stat_summary(position = position_dodge2(width = .5)) +
  scale_color_pronouns +
  labs(y = "log residualized RT", color = "pronoun gender") +
  facet_wrap(~expect, nrow = 1) +
  THEME_POSTER +
  theme(legend.position = "none")
if (BATCH == "pre") ggsave(
  file.path(outdir_poster, glue::glue("maze_expect_{BATCH}.pdf")), width = 3.5, height = 2.5
)


maze_expectations |>
  plot_task_expectations_hist(BATCH)

ggsave(file.path(outdir_poster, glue::glue("maze_expectation_hist_{BATCH}.pdf")), width = 3.5 , height = 2)

## SPR
spr |>
  filter(batch == BATCH) |>
  mutate(
    pronoun_gender = factor(pronoun_gender, levels = c("she", "he", "they"))
  ) |>
  filter(is_target, is_pron1) |>
  ggplot(aes(
    pronoun_gender, log(rt_gmean),
    color = factor(pronoun_gender)
  )) +
  stat_summary(position = position_dodge2(width = .5)) +
  scale_color_pronouns +
  labs(y = "log residualized RT", color = "pronoun gender") +
  THEME_POSTER +
  theme(legend.position = "none")

ggsave(file.path(outdir_poster, glue::glue("spr_{BATCH}.pdf")), width = 3.25, height = 2.5)

spr |>
  filter(batch == BATCH) |>
  mutate(
    pronoun_gender = factor(pronoun_gender, levels = c("she", "he", "they"))
  ) |>
  filter(is_target, is_pron2) |>
  mutate(match = ifelse(
    type %in% c("she-she", "he-he", "they-they"), "match", "mismatch"
  )) |>
  ggplot(aes(
    pronoun_gender, log(rt_gmean),
    color = factor(pronoun_gender), shape = match, lty = match
  )) +
  stat_summary(position = position_dodge2(width = .5)) +
  scale_color_pronouns +
  guides(shape = guide_legend(), color = "none") +
  labs(y = "log residualized RT", color = "pronoun gender") +
  THEME_POSTER +
  theme(
    legend.position = "bottom",
    legend.margin = margin(0.1, 0.1, 0.1, 0.1, "lines")
  )

ggsave(file.path(outdir_poster, glue::glue("spr2_{BATCH}.pdf")), width = 3.25, height =2.5)

spr_expectations |>
  filter(batch == BATCH) |>
  mutate(
    pronoun_gender = factor(pronoun_gender, levels = c("she", "he", "they")),
    expect = factor(case_when(
      probability_Harris > .51 ~ "Expect Harris",
      probability_Harris <= .49 ~ "Expect Trump",
      .default = "Even"
    ))
  ) |>
  filter(expect != "Even") |>
  drop_na(expect) |>
  filter(is_target, is_pron1) |>
  ggplot(aes(pronoun_gender, log(rt), color = factor(pronoun_gender))) +
  stat_summary(position = position_dodge2(width = .5)) +
  scale_color_pronouns +
  labs(y = "log residualized RT", color = "pronoun gender") +
  facet_wrap(~expect, nrow = 1) +
  THEME_POSTER +
  theme(legend.position = "none")

if (BATCH == "pre") ggsave(
  file.path(outdir_poster, glue::glue("spr_expect_{BATCH}.pdf")), width = 3.5, height = 2.5
)

spr_expectations |>
  plot_task_expectations_hist(BATCH)

ggsave(file.path(outdir_poster, glue::glue("spr_expectation_hist_{BATCH}.pdf")), width = 3.5 , height = 2)

```